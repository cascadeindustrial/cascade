define(['jquery','Magento_Ui/js/modal/alert','jquery/ui','mage/translate','mage/mage','mage/validation'],function($,alert){'use strict';$.widget('mage.aecOrderReview',{options:{orderReviewSubmitSelector:'#review-submit',shippingSelector:'#shipping_method',shippingSubmitFormSelector:null,updateOrderSelector:'#update-order',billingAsShippingSelector:'#billing\\:as_shipping',updateContainerSelector:'#details-reload',waitLoadingContainer:'#review-please-wait',shippingMethodContainer:'#shipping-method-container',agreementSelector:'div.checkout-agreements input',isAjax:false,updateShippingMethodSubmitSelector:'#update-shipping-method-submit',reviewSubmitSelector:'#review-submit',shippingMethodUpdateUrl:null,updateOrderSubmitUrl:null,canEditShippingMethod:false},triggerPropertyChange:true,isShippingSubmitForm:false,_create:function(){var isDisable;if(this.options.isAjax){this._submitOrder=this._ajaxSubmitOrder;}
this.element.on('click',this.options.orderReviewSubmitSelector,$.proxy(this._submitOrder,this)).on('change',this.options.shippingSelector,$.proxy(this._submitUpdateOrder,this,this.options.updateOrderSubmitUrl,this.options.updateContainerSelector)).find(this.options.updateOrderSelector).on('click',$.proxy(this._updateOrderHandler,this)).end().find(this.options.updateShippingMethodSubmitSelector).hide().end();if($(this.options.shippingSubmitFormSelector).length&&this.options.canEditShippingMethod){this.isShippingSubmitForm=true;$(this.options.shippingSubmitFormSelector).find(this.options.updateShippingMethodSubmitSelector).hide().end().on('change',this.options.shippingSelector,$.proxy(this._submitUpdateOrder,this,$(this.options.shippingSubmitFormSelector).prop('action'),this.options.updateContainerSelector));this._updateOrderSubmit(!$(this.options.shippingSubmitFormSelector).find(this.options.shippingSelector).val());}else{isDisable=this.isShippingSubmitForm&&this.element.find(this.options.shippingSelector).val();this.element.on('input propertychange',':input[name]',$.proxy(this._updateOrderSubmit,this,isDisable,this._onShippingChange)).find('select').not(this.options.shippingSelector).on('change',this._propertyChange);this._updateOrderSubmit(isDisable);}},_addressFormChangeHandlerFactory:function(inputName,selector){return function(){var input=this.element.find('[name="'+inputName+'"]');if(!input.length){input=$('<input type="hidden" name="'+inputName+'" value=""/>');input.appendTo(this.element);}
input.val($(selector).serialize());}},_ajaxBeforeSend:function(){this.element.find(this.options.waitLoadingContainer).show();},_ajaxComplete:function(){this.element.find(this.options.waitLoadingContainer).hide();},_propertyChange:function(){$(this).trigger('propertychange');},_updateOrderHandler:function(){$(this.options.shippingSelector).trigger('change');},_submitOrder:function(){if(this._validateForm()){this.element.find(this.options.updateOrderSelector).fadeTo(0,0.5).end().find(this.options.waitLoadingContainer).show().end().submit();this._updateOrderSubmit(true);}},_ajaxSubmitOrder:function(){if(this.element.find(this.options.waitLoadingContainer).is(':visible')){return false;}
$.ajax({url:this.element.prop('action'),type:'post',context:this,data:{isAjax:1},dataType:'json',beforeSend:this._ajaxBeforeSend,complete:this._ajaxComplete,success:function(response){var msg;if($.type(response)==='object'&&!$.isEmptyObject(response)){if(response['error_messages']){this._ajaxComplete();msg=response['error_messages'];if(msg){if($.type(msg)==='array'){msg=msg.join('\n');}}
alert({content:msg});return false;}
if(response.redirect){$.mage.redirect(response.redirect);return false;}else if(response.success){$.mage.redirect(this.options.successUrl);return false;}
this._ajaxComplete();alert({content:$.mage.__('Sorry, something went wrong.')});}},error:function(){alert({content:$.mage.__('Sorry, something went wrong. Please try again later.')});this._ajaxComplete();}});},_validateForm:function(){this.element.find(this.options.agreementSelector).off('change').on('change',$.proxy(function(){var isValid=this._validateForm();this._updateOrderSubmit(!isValid);},this));var valid=true;if(this.element.data('mageValidation')){return this.element.validation().valid()&&valid;}
return valid;},_updateOrderSubmit:function(shouldDisable,fn){this._toggleButton(this.options.orderReviewSubmitSelector,shouldDisable);if($.type(fn)==='function'){fn.call(this);}},_toggleButton:function(button,disable){$(button).prop({'disabled':disable}).toggleClass('no-checkout',disable).fadeTo(0,disable?0.5:1);},_submitUpdateOrder:function(url,resultId){var isChecked,formData,callBackResponseHandler,shippingMethod;if(this.element.find(this.options.waitLoadingContainer).is(':visible')){return false;}
isChecked=$(this.options.billingAsShippingSelector).is(':checked');formData=null;callBackResponseHandler=null;shippingMethod=$.trim($(this.options.shippingSelector).val());if(url&&resultId&&shippingMethod){this._updateOrderSubmit(true);this._toggleButton(this.options.updateOrderSelector,true);if(this.isShippingSubmitForm){formData=$(this.options.shippingSubmitFormSelector).serialize()+'&isAjax=true&form_key='+$.cookie('form_key');callBackResponseHandler=function(response){$(resultId).html(response);this._updateOrderSubmit(false);this._ajaxComplete();};}else{formData=this.element.serialize()+'&isAjax=true';callBackResponseHandler=function(response){$(resultId).html(response);this._ajaxShippingUpdate(shippingMethod);};}
if(isChecked){$(this.options.shippingSelect).prop('disabled',true);}
$.ajax({url:url,type:'post',context:this,beforeSend:this._ajaxBeforeSend,data:formData,success:callBackResponseHandler});}},_ajaxShippingUpdate:function(shippingMethod){$.ajax({url:this.options.shippingMethodUpdateUrl,data:{isAjax:true,shipping_method:shippingMethod,form_key:$.cookie('form_key')},type:'post',context:this,success:function(response){$(this.options.shippingMethodContainer).parent().html(response);this._toggleButton(this.options.updateOrderSelector,false);this._updateOrderSubmit(false);},complete:this._ajaxComplete});},_onShippingChange:function(){if(this.triggerPropertyChange&&$.trim($(this.options.shippingSelector).val())){this.element.find(this.options.shippingSelector).hide().end().find(this.options.shippingSelector+'_update').show();}}});return $.mage.orderReview;});