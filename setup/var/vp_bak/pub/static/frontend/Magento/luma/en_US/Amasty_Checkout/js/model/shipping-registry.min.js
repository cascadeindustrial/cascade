define(['ko','underscore','Magento_Checkout/js/model/quote','Magento_Checkout/js/model/shipping-rates-validation-rules','Magento_Checkout/js/model/shipping-rate-registry','Magento_Checkout/js/model/shipping-address/form-popup-state','Magento_Checkout/js/model/address-converter','Magento_Customer/js/model/address-list','Amasty_Checkout/js/model/address-form-state','Amasty_Checkout/js/action/get-address-cache-key','Amasty_Checkout/js/model/payment/payment-loading','Magento_Ui/js/lib/validation/validator'],function(ko,_,quote,validationRules,rateRegistry,formPopUpState,addressConverter,addressList,addressFormState,getAddressCacheKey,paymentLoader,validator){'use strict';return{savedAddress:'',shippingMethod:'',shippingCarrier:'',addressComponents:[],observedComponents:[],additionalAddressValues:{},excludedFieldsNames:[],excludedCollectionNames:['billing-address-form'],isEstimationHaveError:ko.observable(false),isAddressChanged:ko.observable(false).extend({notify:'always',rateLimit:20}),validationTimeout:0,checkDelay:1000,initObservers:function(elems){if(_.isEmpty(this.addressComponents)){this.excludedFieldsNames=_.union(this.excludedFieldsNames,validationRules.getObservableFields());this.filterElements(elems());_.each(this.addressComponents,function(element){if(this.excludedFieldsNames.indexOf(element.index)===-1){this.observedComponents.push(element);this.additionalAddressValues[element.index]=this.getInitialValue(element.index);}
element.on('value',this.triggerValidation.bind(this,element));},this);}},setInitialValues:function(){var savedAddress=window.checkoutConfig.shippingAddressFromData,savedMethod=window.checkoutConfig.selectedShippingMethod,subscriber,cacheKey;if(savedAddress){this.savedAddress=addressConverter.formAddressDataToQuoteAddress(savedAddress);cacheKey=getAddressCacheKey(this.savedAddress);rateRegistry.set(cacheKey,window.checkoutConfig.quoteData.initRates);}else if(window.checkoutConfig.selectedShippingAddressId){if(addressList.getLength()){this._setCustomerAddress(addressList());}else{subscriber=addressList.subscribe(function(addreses){this._setCustomerAddress(addreses);subscriber.dispose();},this);}}
if(savedMethod){if(_.isObject(savedMethod)){this.shippingMethod=savedMethod.method_code;this.shippingCarrier=savedMethod.carrier_code;}else if(_.isString(savedMethod)){savedMethod=savedMethod.split('_');this.shippingMethod=savedMethod[0];this.shippingCarrier=savedMethod[1];}}},_setCustomerAddress:function(addresses){var selectedAddress;selectedAddress=_.find(addresses,function(address){return address.customerAddressId*1===window.checkoutConfig.selectedShippingAddressId*1;});if(selectedAddress){this.savedAddress=selectedAddress;rateRegistry.set(selectedAddress.getKey(),window.checkoutConfig.quoteData.initRates);}},getInitialValue:function(index){var savedAddress=window.checkoutConfig.shippingAddressFromData;if(savedAddress){if(savedAddress.custom_attributes&&savedAddress.custom_attributes[index]){return savedAddress.custom_attributes[index];}else if(savedAddress[index]){return savedAddress[index];}}
return null;},filterElements:function(elems){if(!elems||!elems.length){return;}
_.each(elems,function(element){if(this._isCollection(element)){try{if(this._isCollectionValid(element)){this.filterElements(element.elems());}}catch(e){}
return;}
if(this._isModuleValid(element)){this.addressComponents.push(element);}}.bind(this));},_isCollection:function(element){return typeof element.initChildCount==='number';},_isCollectionValid:function(element){return this.excludedCollectionNames.indexOf(element.index)===-1;},_isModuleValid:function(module){return ko.isObservable(module.error)&&ko.isObservable(module.value);},triggerValidation:function(){clearTimeout(this.validationTimeout);if(!formPopUpState.isVisible()&&!addressFormState.isShippingFormVisible()){paymentLoader(true);this.validationTimeout=setTimeout(this.validation.bind(this),this.checkDelay);}},validation:function(){var isError=false,valueChanged=false,result;_.find(this.observedComponents,function(element){if(element.visible&&!element.visible()||element.disabled&&element.disabled()){return false;}
if(element.error()){isError=true;return true;}
if(_.isObject(element.validation)){result=validator(element.validation,element.value(),element.validationParams);if(!result.passed){isError=true;return true;}}
if(this.additionalAddressValues[element.index]!==element.value()){valueChanged=true;}
return false;},this);this.isEstimationHaveError(isError);if(!isError){this.isAddressChanged(valueChanged);}else{paymentLoader(false);}},registerAdditionAddressValues:function(){clearTimeout(this.validationTimeout);_.each(this.observedComponents,function(element){this.additionalAddressValues[element.index]=element.value();}.bind(this));},register:function(address){if(!address){address=quote.shippingAddress();}
this.savedAddress=address;this.shippingMethod=quote.shippingMethod().method_code;this.shippingCarrier=quote.shippingMethod().carrier_code;this.registerAdditionAddressValues();},isHaveUnsavedShipping:function(){var methodData=quote.shippingMethod();if(!methodData){return false;}
if(!this.savedAddress){return true;}
return this.isAddressChanged()||!this._compareObjectsData(quote.shippingAddress(),this.savedAddress)||this.shippingMethod!==methodData.method_code||this.shippingCarrier!==methodData.carrier_code;},_compareObjectsData:function(quoteAddress,savedAddress){if(quoteAddress.getType&&quoteAddress.getType()==='customer-address'){return quoteAddress.customerAddressId===savedAddress.customerAddressId;}
quoteAddress=_.pick(quoteAddress,this._cleanupAddressFunction);savedAddress=_.pick(savedAddress,this._cleanupAddressFunction);if(quoteAddress.regionId){quoteAddress.regionId*=1;}
if(savedAddress.regionId){savedAddress.regionId*=1;}
return _.isEqual(quoteAddress,savedAddress);},_cleanupAddressFunction:function(value,key){return!_.isFunction(value)&&key!=='save_in_address_book'&&value&&(!_.isEmpty(value)||_.isNumber(value));}};});