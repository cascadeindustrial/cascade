define(['jquery','Magento_Ui/js/form/form','ko','Cart2Quote_Quotation/js/quote-checkout/action/place-quote','Cart2Quote_Quotation/js/quote-checkout/action/update-quote','Magento_Checkout/js/action/set-shipping-information','Magento_Checkout/js/model/shipping-service','Magento_Checkout/js/model/quote','Cart2Quote_Quotation/js/quote-checkout/model/email-form-usage-observer','Cart2Quote_Quotation/js/quote-checkout/model/quote-checkout-model-selector','Magento_Customer/js/model/customer'],function($,Component,ko,placeQuoteAction,updateQuoteAction,setShippingInformationAction,shippingService,quote,emailFormUsageObserver,selector,customer){'use strict';return Component.extend({defaults:{template:'Cart2Quote_Quotation/quote-checkout/view/add-to-quote-button'},isVirtual:quote.isVirtual(),showFields:emailFormUsageObserver.showFields,allowToUseForm:emailFormUsageObserver.allowToUseForm(),displayShippingMethods:emailFormUsageObserver.displayShippingMethods(),shippingReady:ko.observable(false),billingReady:ko.observable(false),quotationReady:ko.observable(false),readyToRequest:null,isCustomerLoggedIn:customer.isLoggedIn,showLoginButton:null,showRequestButton:null,initialize:function(){this._super();var self=this;this.initLoginButton();this.initRequestButton();$('.cart-summary').mage('sticky');shippingService.isLoading.subscribe(function(){$('*[data-role="opc-continue"]').remove();});this.readyToRequest=ko.computed(function(){return(this.shippingReady()&&this.billingReady()&&this.quotationReady());},this);this.readyToRequest.subscribe(function(readyToRequest){if(readyToRequest===true){updateQuoteAction().success(function(){var checkoutAsGuest=false;if(!self.isCustomerLoggedIn()&&selector.hasGuestCheckoutFields()){checkoutAsGuest=!selector.getGuestCheckoutModel().requestAccount();}
if(selector.hasBillingAddress()){placeQuoteAction(selector.getBillingModel().isAddressSameAsShipping(),checkoutAsGuest);}else{placeQuoteAction(true,checkoutAsGuest);}
self.shippingReady(false);self.billingReady(false);self.quotationReady(false);});}});},validateQuote:function(){var checkAddress=true;var formFieldVisible=this.allowToUseForm&&(selector.hasShippingAddress()||selector.hasBillingAddress()||this.isVirtual);if(!this.isCustomerLoggedIn()){if(selector.hasGuestCheckoutFields()&&selector.getGuestCheckoutModel().showRequestShippingQuote()){checkAddress=selector.getGuestCheckoutModel().requestAccount()||selector.getGuestCheckoutModel().allowToUseGuest()===2;}}
if(checkAddress&&formFieldVisible){this.setDefaultShipping();this.checkShippingAddress();this.checkBillingAddress();}else{this.shippingReady(true);this.billingReady(true);}
if(selector.hasQuotationFields()&&checkAddress){emailFormUsageObserver.copyNamesToGuest();}
this.quotationReady(selector.getQuotationModel().validateFields());if(!this.quotationReady()){this.scrollToError();}},setDefaultShipping:function(){if(!this.displayShippingMethods&&!this.isVirtual){quote.shippingMethod({"method_code":"quotation","carrier_code":"quotation"});}},checkBillingAddress:function(){if(!selector.getBillingModel().isAddressSameAsShipping()){selector.getBillingModel().updateAddress();if(!selector.getBillingModel().source.get('params.invalid')){this.billingReady(true);}else{this.billingReady(false);$("#billing").collapsible("activate");this.scrollToError();}}else{var self=this;selector.getBillingModel().updateByShippingAddress().done(function(){self.billingReady(true);});}},checkShippingAddress:function(){if(!this.isVirtual){if(selector.getShippingModel().validateShippingInformation()){var self=this;setShippingInformationAction().done(function(){self.shippingReady(true);});}else{this.shippingReady(false);$(".checkout-shipping-address").collapsible("activate");if(selector.hasShippingMethod()){$("#opc-shipping_method").collapsible("activate");}
this.scrollToError();}}else{this.shippingReady(true);}},scrollToError:function(){var errorElement=$('._error').get(0);if(typeof errorElement!=='undefined'){var offset=$(errorElement).offset();if(typeof offset!=='undefined'){$('html, body').animate({scrollTop:$(errorElement).offset().top},500);}}},initLoginButton:function(){var self=this;self.showLoginButton=ko.computed(function(){return!self.isCustomerLoggedIn()&&!self.allowToUseForm});},initRequestButton:function(){var self=this;self.showRequestButton=ko.computed(function(){return((self.showFields()&&self.allowToUseForm)||(self.isCustomerLoggedIn()&&!self.allowToUseForm))});},setLoginModalEvents:function(){$('.login').trigger('contentUpdated');}});});