define(['underscore','Plumrocket_CookieConsent/js/lib/js.cookie','jquery'],function(_,jsCookie,$){'use strict';var CUSTOMER_CONSENT='pr-cookie-consent';var SYSTEM_COOKIES=['PHPSESSID',CUSTOMER_CONSENT,'user_allowed_save_cookie',];var config={canManageCookie:null,canUseCookieBeforeOptIn:null,canBlockUnknownCookie:null,consent:{isLoggedIn:null,logUrl:null,reloadAfterAccept:null,reloadAfterDecline:null,expiry:null},cookie:{path:null,domain:null},mage:{website:null,cookieName:null,lifetime:null},cookieToCategoryMapping:null,essentialCategoryKeys:null};function CookieRestriction(){this.debugMode=0;this.configuredCallbacks=[];this.queue={};this.setCookieByCallBack=function(cookieName,cookieSetter){this.log('Catch set cookie "'+cookieName+'"');if(this.isSystemCookie(cookieName)){this.log('System cookie "'+cookieName+'" have set');return cookieSetter();}
if(this.isConfigured()){if(this.isAllowed(cookieName)){this.log('Allowed cookie "'+cookieName+'" has set');return cookieSetter()}else{this.warn('Setting of cookie "'+cookieName+'" was blocked by cookie consent extension');}}else{this.addToQueue(cookieName,cookieSetter);}};this.allowAllCategories=function(){this.setCustomerConsent(['*']);return this.cache.reset();};this.declineAll=function(){this.setCustomerConsent([]);return this.cache.reset();};this.isConfigured=function(){return config.canManageCookie!==null;};this.addConfiguredCallback=function(callback){this.configuredCallbacks.push(callback);return this;};this.isOptIn=function(){return Boolean(this.getCustomerConsent());};this.getCustomerConsent=function(){var consent=jsCookie.get(CUSTOMER_CONSENT);return consent?JSON.parse(consent):false;};this.setCustomerConsent=function(allowedCategories){jsCookie.set(CUSTOMER_CONSENT,JSON.stringify(allowedCategories),{expires:config.consent.expiry,path:config.cookie.path,domain:config.cookie.domain});if(_.contains(allowedCategories,'*')){this.websiteRestriction.allowCurrent();}else{this.websiteRestriction.disallowCurrent();}
var isAccepting=allowedCategories.length;var self=this;$.post(config.consent.logUrl,{acceptedKeys:allowedCategories}).always(function(){self.reloadAfterAction(isAccepting);});};this.isAllowed=function(cookieName){if(this.isSystemCookie(cookieName)){return true;}
if(!config.canManageCookie){return true;}
if(!this.isOptIn()){if(config.canUseCookieBeforeOptIn){return true;}
if(this.isKnownCookie(cookieName)){return this.isInEssentialCategory(cookieName);}
return false;}
if(!this.isKnownCookie(cookieName)){return!config.canBlockUnknownCookie;}
return this.isInAllowedCategory(cookieName);};this.isAllowedCategory=function(categoryKey){if(!config.canManageCookie){return true;}
if(this.isEssentialCategory(categoryKey)){return true;}
if(this.isOptIn()){if(this.isAllCategoriesAllowed()){return true;}
return _.contains(this.getCustomerConsent(),categoryKey);}
return config.canUseCookieBeforeOptIn;};this.clearRejectedCookie=function(){var self=this;_.each(jsCookie.get(),function(value,cookieName){if(!self.isAllowed(cookieName)){jsCookie.remove(cookieName);self.warn('Remove cookie "'+cookieName+'"');}});};this.isSystemCookie=function(cookieName){return _.contains(SYSTEM_COOKIES,cookieName);};this.isKnownCookie=function(cookieName){return config.cookieToCategoryMapping.hasOwnProperty(cookieName);};this.isAllCategoriesAllowed=function(){if(null===this.cache.get('allowAllCategories')){var customerConsent=this.getCustomerConsent();if(customerConsent&&_.contains(customerConsent,'*')){this.cache.set('allowAllCategories',true);}else{var allowedWebsites=this.websiteRestriction.getAllowed();this.cache.set('allowAllCategories',allowedWebsites[config.mage.website]===1);}}
return this.cache.get('allowAllCategories');};this.getCookieCategory=function(cookieName){return config.cookieToCategoryMapping[cookieName];};this.isInEssentialCategory=function(cookieName){return this.isEssentialCategory(this.getCookieCategory(cookieName));};this.isEssentialCategory=function(categoryKey){return _.contains(config.essentialCategoryKeys,categoryKey);};this.isInAllowedCategory=function(cookieName){return this.isAllowedCategory(this.getCookieCategory(cookieName));};this.configure=function(configJson){try{config=JSON.parse(configJson);}catch(e){this.log('Error has happened during parse JSON',this);return false;}
this.configuredCallbacks.forEach(function(callback){callback();}.bind(this));this.log('Cookie restriction configuration complete',config);this.clearRejectedCookie();};this.reloadAfterAction=function(isAccepting){if(isAccepting&&config.consent.reloadAfterAccept){window.location.reload();}
if(!isAccepting&&config.consent.reloadAfterDecline){window.location.reload();}};this.addToQueue=function(cookieName,cookieSetter){this.queue[cookieName]=cookieSetter;this.log('Cookie "'+cookieName+'" was add to queue');};this.runQueue=function(){_.each(this.queue,function(cookieSetter,cookieName){this.log('Set Cookie "'+cookieName+'" by queue');this.setCookieByCallBack(cookieName,cookieSetter);}.bind(this));};this.addConfiguredCallback(this.runQueue.bind(this));this.log=function(){if(this.debugMode>1){console.log.apply(null,arguments);}};this.warn=function(){if(this.debugMode>0){console.warn.apply(null,arguments);}};}
CookieRestriction.prototype.cache={originCacheData:undefined,cacheData:{allowAllCategories:null},get:function(key){return this.cacheData[key];},set:function(key,value){if(!this.originCacheData){this.originCacheData=this.cacheData;}
this.cacheData[key]=value;return this;},reset:function(){if(this.originCacheData){this.cacheData=this.originCacheData;}
return this;}};CookieRestriction.prototype.websiteRestriction={getAllowed:function(){var allowedWebsites=jsCookie.getJSON(config.mage.cookieName);return(allowedWebsites!==undefined)?allowedWebsites:{};},allowCurrent:function(){return this.set(config.mage.website,true);},disallowCurrent:function(){return this.set(config.mage.website,false);},set:function(website,flag){var allowedWebsites=this.getAllowed();if(flag){allowedWebsites[website]=1;}else{delete allowedWebsites[website];}
this.jsCookieWithConverter.set(config.mage.cookieName,allowedWebsites,{path:config.cookie.path,expires:config.mage.lifetime?Math.ceil(config.mage.lifetime / 86400):0});return this;},jsCookieWithConverter:jsCookie.withConverter({write:function(value,key){return encodeURIComponent(value);}})};return new CookieRestriction();});