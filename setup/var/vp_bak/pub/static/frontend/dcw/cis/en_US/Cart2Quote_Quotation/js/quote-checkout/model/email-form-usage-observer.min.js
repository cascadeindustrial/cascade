define(['ko','jquery','uiComponent','Magento_Checkout/js/model/shipping-service','Cart2Quote_Quotation/js/quote-checkout/model/quote-checkout-model-selector','Cart2Quote_Quotation/js/quote-checkout/checkout-data-quotation'],function(ko,$,Component,shippingService,selector,checkoutQuotationData){"use strict";return Component.extend({loaded:false,showGuestField:ko.observable(false),showNonGuestField:ko.observable(false),showFields:ko.observable(false),initialize:function(){var self=this;this._super();this.showGuestField.extend({notify:'always'});this.showNonGuestField.extend({notify:'always'});this.showFields.extend({notify:'always'});if(!this.allowToUseForm()){this.initAllowToUseForm();}else{shippingService.isLoading.subscribe(function(isLoading){if(!isLoading&&!this.loaded){this.initAllowToUseForm();setTimeout(function(){self.initCopyNameService();},1500);this.loaded=true;if(selector.hasLoginModel()){selector.getLoginModel().emailHasChanged();}
if(selector.hasGuestCheckoutFields()){selector.getGuestCheckoutModel().requestAccount.subscribe(function(){self.updateFields()});}}},this);}},initAllowToUseForm:function(){var self=this;self.updateFields();if(selector.hasLoginModel()){selector.getLoginModel().email.subscribe(function(){self.updateFields()});selector.getLoginModel().isPasswordVisible.subscribe(function(){self.updateFields()});}},updateFields:function(){var validForShow=true,requestAccount=true,configAllowForm=this.allowToUseForm(),existAccount=true;if(selector.hasLoginModel()){validForShow=this.isLoginValid();if(this.registeredQuoteCheckoutMode()=="0"){validForShow=!selector.getLoginModel().isPasswordVisible();}else if(this.registeredQuoteCheckoutMode()=="1"){requestAccount=!selector.getLoginModel().isPasswordVisible();}else if(this.registeredQuoteCheckoutMode()=="2"){existAccount=!selector.getLoginModel().isPasswordVisible();}}
if(this.allowToUseGuest()===1&&existAccount){if(selector.hasGuestCheckoutFields()){requestAccount=selector.getGuestCheckoutModel().requestAccount();}}
var guestAddress=this.allowToUseGuest()===2;if(!existAccount&&guestAddress){this.showGuestField(false);this.showNonGuestField(true);this.showFields(true);}else{this.showGuestField(validForShow&&!requestAccount&&configAllowForm);this.showNonGuestField(validForShow&&requestAccount&&configAllowForm);this.showFields(validForShow&&configAllowForm);}},isLoginValid:function(){if(selector.getLoginFormField().first().val()){selector.getLoginForm().validation();return Boolean(selector.getLoginFormField().valid());}
return false;},initCopyNameService:function(){if(selector.hasGuestCheckoutFields()){selector.getGuestCheckoutModel().requestAccount.subscribe(function(){if(selector.getGuestCheckoutModel().requestAccount()){this.copyNamesFromGuest();}else{this.copyNamesToGuest();}},this);}},copyNamesToGuest:function(){this.updateQuotationFieldToGuest('firstname');this.updateQuotationFieldToGuest('lastname');},copyNamesFromGuest:function(){this.updateQuotationFieldFromGuest('firstname');this.updateQuotationFieldFromGuest('lastname');},updateQuotationFieldToGuest:function(name){var field=this.getField(name,'quotationGuestFieldData');field.val(this.getAddressAttribute(name));field.change();},updateQuotationFieldFromGuest:function(name){var billingAddressField=this.getField(name,'billingAddress');billingAddressField.val(this.getAddressAttribute(name));billingAddressField.change();var shippingAddressField=this.getField(name,'shippingAddress');shippingAddressField.val(this.getAddressAttribute(name));shippingAddressField.change();},getAddressAttribute:function(name){var value='';if(this.getField(name,'billingAddress').val()!==''){value=this.getField(name,'billingAddress').val();}else if(this.getField(name,'shippingAddress').val()!==''){value=this.getField(name,'shippingAddress').val();}else{value=this.getField(name,'quotationGuestFieldData').val()}
return value;},getField:function(fieldName,type){return $('[name="'+type+'.'+fieldName+'"] input');},allowToUseGuest:function(){return Number(checkoutQuotationData.getQuotationConfigDataFromData().allowGuest);},allowToUseForm:function(){return Boolean(checkoutQuotationData.getQuotationConfigDataFromData().allowForm);},displayShippingMethods:function(){return Boolean(checkoutQuotationData.getQuotationConfigDataFromData().displayShipping);},registeredQuoteCheckoutMode:function(){return checkoutQuotationData.getQuotationConfigDataFromData().registeredQuoteCheckout;},displayMethodSwitcher:function(){return checkoutQuotationData.getQuotationConfigDataFromData().displaySwitcher;}})();});