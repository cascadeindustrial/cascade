define(['jquery','prototype','aitconfProduct','aitconfCourier'],function(jQuery,prototype,EC_Product,EC_Courier){var EC_Helper=new Class.create();EC_Helper.prototype={blockMain:null,blockLitebox:null,productParametes:Array('name','autogenerate_name','sku','autogenerate_sku','weight','price','status','visibility','stock','qty','is_changed'),productAttributes:null,productStatuses:Array('unchanged','changed','invalid','duplicate'),parameters:$H({}),newProductIndex:0,temporaryIds:null,timer:null,running:false,initialize:function(){this.blockMain=$('easyconf-main-table');this.blockLitebox=$('easyconf-litebox');this.productAttributes=new Array();},createNewProductId:function(){return"new"+(++this.newProductIndex);},addAttributeId:function(attributeId){this.productAttributes.push(attributeId);},setParameter:function(parameter,value){this.parameters.set(parameter,value);},getParameter:function(parameter){return this.parameters.get(parameter);},setHasChanges:function(){$('aiteasyconf_has_changes').value=1;return this;},getHasChanges:function(){return $('aiteasyconf_has_changes').value;},getActionUrl:function(action){var _url=this.getParameter('controllerUrl').replace('xxxxx',action);return _url;},getProductsIds:function(){var ids=new Array();this.blockMain.select('td[id^="product-column-"]').each(function(column){ids.push(column.id.replace('product-column-',''));});return ids;},createProduct:function(){if(!this.checklimit(1)){alert(ec_translator.say('limitexceeded_create'));return false;}
var newId=this.createNewProductId();var columnContent=$('product-column-blank').innerHTML.replace(new RegExp('blank','g'),newId.toString());var column=new Element('td',{id:"product-column-"+newId}).update(columnContent);$('easyconf-main-row').insert(column,{position:"bottom"});this.setHasChanges()
return newId;},deleteProduct:function(id){if(confirm(ec_translator.say('confirmdelete'))){var _product=new EC_Product(id);_product.remove()}},deleteAll:function(confirmation){if(typeof confirmation=="undefined"){confirmation=true;}
var ids=this.getProductsIds();var _count=ids.length;if(_count>0){if(confirmation&&!confirm(ec_translator.say('confirmdelete'))){return false;}
var _id;while(_id=ids.pop()){var _product=new EC_Product(_id);_product.remove()}
if(confirmation){ec_messenger.clear();ec_messenger.message(ec_translator.say('allproductsremoved').replace('###',_count),1);}}
return true;},toggleAllOptions:function(checkbox){var id=checkbox.id.replace('generate-all-','');this.blockMain.select('input[id^="generate-'+id+'-"]').each(function(option){option.checked=checkbox.checked;});},setProductStatus:function(id,status){var _product=new EC_Product(id);_product.setStatus(status);},decorate:function(id){var block=(id)?($('product-attributes-'+id)):($('easyconf-container'));var radiobuttons=block.select('input[type="radio"]');radiobuttons.each(function(radiobutton){radiobutton.up().up().removeClassName('cell-selected');if(radiobutton.checked==true){radiobutton.up().up().addClassName('cell-selected');}});},toggleLitebox:function(flag){if(true==flag){this.blockLitebox.show();}
else{this.blockLitebox.hide();}},store_statuses:function(ids){var tmpStatuses=$H({});ids.each(function(_id){var _product=new EC_Product(_id);tmpStatuses.set(_id,_product.getStatus());});this.setParameter('tmpStatuses',tmpStatuses);},restore_statuses:function(){var tmpStatuses=this.getParameter('tmpStatuses');if(tmpStatuses){tmpStatuses.each(function(pair){var _product=new EC_Product(pair.key);if(_product.exists()){_product.setStatus(pair.value);}});}},save:function(){if(1==this.getHasChanges()){ec_messenger.clear();ec_progressBar.setText(ec_translator.say('pleasewait'));ec_progressBar.show();this.ajax_cleartemp();return true;}else{jQuery('[data-index="configurable-products-pro"] > div > fieldset').remove();this.saveMainProduct();}
return true;},ajax_cleartemp:function(standalone){if(standalone){ec_progressBar.show();}
ec_progressBar.setText(ec_translator.say('ajax_cleartemp'));var data='form_key='+FORM_KEY+'&mainId='+this.getParameter('mainId')
+'&hasChanges='+this.getHasChanges();var _courier=new EC_Courier(this.getActionUrl('cleartemp'));var _result=_courier.request(data);if(false==_result){ec_progressBar.hide();return false;}
ec_progressBar.logSuccess(ec_translator.say('ajax_cleartemp_success'));if(standalone){ec_progressBar.hide();return true;}
this.temporaryIds=this.getProductsIds();this.timer=setInterval(this.ajax_storetemp.bind(this),500);return true;},ajax_storetemp:function(){if(true==this.running){return false;}
ec_progressBar.setText(ec_translator.say('ajax_storetemp'));this.running=true;var s=this.getParameter('batchSize');var _id;var data='form_key='+FORM_KEY+'&mainId='+this.getParameter('mainId')
+'&hasChanges='+this.getHasChanges();while((--s>=0)&&(_id=this.temporaryIds.shift())){var _product=new EC_Product(_id).load();data+=_product.toQueryString();}
var _courier=new EC_Courier(this.getActionUrl('storetemp'));var _result=_courier.request(data);if(false==_result){ec_progressBar.hide();clearInterval(this.timer);this.running=false;return false;}
ec_progressBar.logSuccess(ec_translator.say('ajax_storetemp_success_batch').replace('###',_result.text.count));if(0==this.temporaryIds.length){ec_progressBar.logSuccess(ec_translator.say('ajax_storetemp_success_all'));clearInterval(this.timer);this.running=false;this.ajax_validate();return true;}
this.running=false;return true;},ajax_validate:function(){ec_progressBar.setText(ec_translator.say('ajax_validate'));var data='form_key='+FORM_KEY+'&mainId='+this.getParameter('mainId')
+'&hasChanges='+this.getHasChanges();var _courier=new EC_Courier(this.getActionUrl('validate'));var _result=_courier.request(data);if(false==_result){ec_progressBar.hide();return false;}
this.restore_statuses();if('invalid'==_result.text.status){var ids=eval(_result.text.ids);this.store_statuses(ids);ids.each(function(_id){var _product=new EC_Product(_id);_product.setStatus('invalid');});ec_messenger.clear();ec_messenger.message(ec_translator.say('productsinvalid').replace('###',_result.text.count),2);ec_progressBar.hide();return true;}
if('duplicates'==_result.text.status){if(confirm(ec_translator.say('deleteduplicates').replace('###',_result.text.count))){this.ajax_remove_duplicates();return true;}else{var ids=eval(_result.text.ids);this.store_statuses(ids);ids.each(function(_id){var _product=new EC_Product(_id);_product.setStatus('duplicate');});ec_messenger.clear();ec_messenger.message(ec_translator.say('duplicatesmarked'),1);ec_progressBar.hide();return true;}}
if('allok'==_result.text.status){ec_progressBar.logSuccess(ec_translator.say('ajax_validate_success'));this.ajax_delete_products();return true;}
ec_progressBar.hide();return false;},ajax_remove_duplicates:function(){ec_progressBar.setText(ec_translator.say('ajax_remove_duplicates'));var data='form_key='+FORM_KEY+'&mainId='+this.getParameter('mainId')
+'&hasChanges='+this.getHasChanges();var _courier=new EC_Courier(this.getActionUrl('removeduplicates'));var _result=_courier.request(data);if(false==_result){ec_progressBar.hide();return false;}
ec_progressBar.logSuccess(ec_translator.say('ajax_remove_duplicates_success').replace('###',_result.text.count));this.ajax_delete_products();return true;},ajax_delete_products:function(){ec_progressBar.setText(ec_translator.say('ajax_delete_products'));var data='form_key='+FORM_KEY+'&mainId='+this.getParameter('mainId')
+'&hasChanges='+this.getHasChanges();var _courier=new EC_Courier(this.getActionUrl('delete'));var _result=_courier.request(data);if(false==_result){ec_progressBar.hide();return false;}
ec_progressBar.logSuccess(ec_translator.say('ajax_delete_products_success').replace('###',_result.text.count));this.timer=setInterval(this.ajax_save.bind(this),500);return true;},ajax_save:function(){if(true==this.running){return false;}
ec_progressBar.setText(ec_translator.say('ajax_save'));this.running=true;var data='form_key='+FORM_KEY+'&mainId='+this.getParameter('mainId')
+'&hasChanges='+this.getHasChanges();var _courier=new EC_Courier(this.getActionUrl('save'));var _result=_courier.request(data);if(false==_result){clearInterval(this.timer);this.running=false;ec_progressBar.hide();return false;}
if('savedAll'==_result.text.status){ec_progressBar.logSuccess(ec_translator.say('ajax_save_success_all'));clearInterval(this.timer);this.running=false;ec_messenger.message(ec_translator.say('savingmain'),1);ec_progressBar.hide();this.saveMainProduct();return true;}
else{ec_progressBar.logSuccess(ec_translator.say('ajax_save_success_batch').replace('###',_result.text.count));this.running=false;return true;}
ec_progressBar.hide();return false;},beforeSave:function(){this.ignoreRestoration(true);if($('generation-form')){$('generation-form').remove();}
if($('product-config-form')){$('product-config-form').remove();}},saveMainProduct:function(){this.beforeSave();return true;},ajax_generate:function(options,common){ec_progressBar.setText(ec_translator.say('ajax_generate'));ec_progressBar.show();var data='form_key='+FORM_KEY+'&mainId='+this.getParameter('mainId')
+'&hasChanges='+this.getHasChanges();data+='&options='+options;data+='&common='+common;var _courier=new EC_Courier(this.getActionUrl('generate'));var _result=_courier.request(data);if(false==_result){ec_progressBar.hide();return false;}
$('easyconf-main-row').insert(_result.text.html);this.setHasChanges();ec_helper.decorate();ec_messenger.clear();ec_messenger.message(ec_translator.say('generated').replace('###',_result.text.count),1);ec_progressBar.hide();return true;},ajax_restore:function(){$('easyconf-restore').remove();ec_progressBar.setText(ec_translator.say('ajax_restore'));ec_progressBar.show();var data='form_key='+FORM_KEY+'&mainId='+this.getParameter('mainId')
+'&hasChanges='+this.getHasChanges();var _existingIds=Object.toJSON(this.getProductsIds());data+='&existingIds='+_existingIds;var _courier=new EC_Courier(this.getActionUrl('restore'));var _result=_courier.request(data);if(false==_result){ec_progressBar.hide();return false;}
$('easyconf-main-row').insert(_result.text.html);this.setHasChanges();ec_helper.decorate();ec_messenger.clear();ec_messenger.message(ec_translator.say('restored').replace('###',_result.text.count),1);ec_progressBar.hide();return true;},ignoreRestoration:function(clear){if($('easyconf-restore')){$('easyconf-restore').remove();if(clear){this.ajax_cleartemp(true);}}},checklimit:function(addQty){if(this.getParameter('useLimit')){var existingQty=this.getProductsIds().length;var limit=this.getParameter('productsLimit');return((existingQty+addQty)<=limit);}
else{return true;}}};return EC_Helper;});