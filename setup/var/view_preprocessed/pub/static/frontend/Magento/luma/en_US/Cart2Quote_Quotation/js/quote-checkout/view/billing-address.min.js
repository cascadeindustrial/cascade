define(['jquery','ko','Magento_Ui/js/form/form','Magento_Customer/js/model/customer','Magento_Customer/js/model/address-list','Magento_Checkout/js/model/quote','Magento_Checkout/js/action/create-billing-address','Magento_Checkout/js/action/select-billing-address','Magento_Checkout/js/checkout-data','Magento_Checkout/js/model/checkout-data-resolver','Magento_Customer/js/customer-data','Magento_Checkout/js/action/set-billing-address','Magento_Ui/js/model/messageList','mage/translate','uiRegistry','Magento_Checkout/js/model/address-converter','Magento_Checkout/js/action/select-shipping-address','Cart2Quote_Quotation/js/quote-checkout/model/email-form-usage-observer'],function($,ko,Component,customer,addressList,quote,createBillingAddress,selectBillingAddress,checkoutData,checkoutDataResolver,customerData,setBillingAddressAction,globalMessageList,$t,registry,addressConverter,selectShippingAddress,emailFormUsageObserver){'use strict';var lastSelectedBillingAddress=null;var newAddressOption={getAddressInline:function(){return $t('New Address');},customerAddressId:null}
var countryData=customerData.get('directory-data');var addressOptions=addressList().filter(function(address){return address.getType()=='customer-address';});addressOptions.push(newAddressOption);return Component.extend({defaults:{template:'Magento_Checkout/billing-address'},currentBillingAddress:quote.billingAddress,addressOptions:addressOptions,customerHasAddresses:addressOptions.length>1,isVirtual:ko.observable(quote.isVirtual()),allowToUseForm:emailFormUsageObserver.showNonGuestField,initialize:function(){this._super();checkoutDataResolver.resolveBillingAddress();registry.async('checkoutProvider')(function(checkoutProvider){var billingAddressData=checkoutData.getBillingAddressFromData();if(billingAddressData){checkoutProvider.set('billingAddress',$.extend({},checkoutProvider.get('billingAddress'),billingAddressData));}
checkoutProvider.on('billingAddress',function(billingAddressData){checkoutData.setBillingAddressFromData(billingAddressData);});});},initObservable:function(){this._super().observe({selectedAddress:null,isAddressDetailsVisible:true,isAddressFormVisible:!customer.isLoggedIn()||addressOptions.length==1,isAddressSameAsShipping:!quote.isVirtual(),saveInAddressBook:1});quote.billingAddress.subscribe(function(newAddress){if(quote.isVirtual()){this.isAddressSameAsShipping(false);}
if(newAddress!=null&&newAddress.saveInAddressBook!==undefined){this.saveInAddressBook(newAddress.saveInAddressBook);}else{this.saveInAddressBook(1);}},this);return this;},canUseShippingAddress:ko.computed(function(){return!quote.isVirtual()&&quote.shippingAddress()&&quote.shippingAddress().canUseForBilling();}),addressOptionsText:function(address){return address.getAddressInline();},useShippingAddress:function(){if(this.isAddressSameAsShipping()){selectBillingAddress(quote.shippingAddress());if(window.checkoutConfig.reloadOnBillingAddress){setBillingAddressAction(globalMessageList);}
this.isAddressDetailsVisible(true);}else{lastSelectedBillingAddress=quote.billingAddress();quote.billingAddress(null);this.isAddressDetailsVisible(false);}
checkoutData.setSelectedBillingAddress(null);return true;},updateAddress:function(){if(this.selectedAddress()&&this.selectedAddress()!=newAddressOption){selectBillingAddress(this.selectedAddress());checkoutData.setSelectedBillingAddress(this.selectedAddress().getKey());if(window.checkoutConfig.reloadOnBillingAddress){setBillingAddressAction(globalMessageList);}}else{this.source.set('params.invalid',false);this.source.trigger(this.dataScopePrefix+'.data.validate');if(!this.source.get('params.invalid')){var addressData=this.source.get(this.dataScopePrefix),newBillingAddress;if(customer.isLoggedIn()&&!this.customerHasAddresses){this.saveInAddressBook(1);}
addressData.save_in_address_book=this.saveInAddressBook()?1:0;newBillingAddress=createBillingAddress(addressData);selectBillingAddress(newBillingAddress);checkoutData.setSelectedBillingAddress(newBillingAddress.getKey());checkoutData.setNewCustomerBillingAddress(addressData);setBillingAddressAction(globalMessageList);}}
if(this.isVirtual()){this.updateBillingAddress(newBillingAddress);setBillingAddressAction(globalMessageList);}},updateByShippingAddress:function(){selectBillingAddress(quote.shippingAddress());return setBillingAddressAction(globalMessageList);},updateBillingAddress:function(addressData){var billingAddress=quote.billingAddress();for(var field in addressData){if(addressData.hasOwnProperty(field)&&billingAddress.hasOwnProperty(field)&&typeof addressData[field]!='function'&&_.isEqual(billingAddress[field],addressData[field])){billingAddress[field]=addressData[field];}else if(typeof addressData[field]!='function'&&!_.isEqual(billingAddress[field],addressData[field])){billingAddress=addressData;break;}}
if(customer.isLoggedIn()){billingAddress.save_in_address_book=1;}
selectShippingAddress(billingAddress);},editAddress:function(){lastSelectedBillingAddress=quote.billingAddress();quote.billingAddress(null);this.isAddressDetailsVisible(false);},cancelAddressEdit:function(){this.restoreBillingAddress();if(quote.billingAddress()){this.isAddressSameAsShipping(quote.billingAddress()!=null&&quote.billingAddress().getCacheKey()==quote.shippingAddress().getCacheKey()&&!quote.isVirtual());this.isAddressDetailsVisible(true);}},restoreBillingAddress:function(){if(lastSelectedBillingAddress!=null){selectBillingAddress(lastSelectedBillingAddress);}},onAddressChange:function(address){this.isAddressFormVisible(address==newAddressOption);this.updateAddress();},getCountryName:function(countryId){return countryData()[countryId]!=undefined?countryData()[countryId].name:'';},updateAddresses:function(){if(window.checkoutConfig.reloadOnBillingAddress||!window.checkoutConfig.displayBillingOnPaymentMethod){setBillingAddressAction(globalMessageList);}},getCode:function(parent){return _.isFunction(parent.getCode)?parent.getCode():'shared';}});});